#!/bin/bash -e
cd ~
. ~/.gcs-x2go
[ -z "$SERVERNAME" ] && exit 1
[ -z "$CHROOTDEBVERSION" ] && export CHROOTDEBVERSION="stretch"

export DEBIAN_FRONTEND=noninteractive
export HOMEDIR_ROOT=~/$SERVERNAME-home
if [ "$SERVER_USE_ROOT" = "true" ] ; then
	export SERVERNAME="/$SERVERNAME"
fi
sudo apt install debootstrap -y
sudo debootstrap $CHROOTDEBVERSION $SERVERNAME
sudo mount --bind /dev/pts $SERVERNAME/dev/pts
sudo mount --bind /dev/shm/ $SERVERNAME/dev/shm
sudo mount --bind /proc $SERVERNAME/proc
sudo mount --bind /sys $SERVERNAME/sys
sudo mkdir -p $HOMEDIR_ROOT/etc
sudo mount --bind $HOMEDIR_ROOT $SERVERNAME/home
sudo chroot $SERVERNAME passwd -l root
awk ' $0 ~ /stretch/ { print $0 " contrib non-free" }' /etc/apt/sources.list | grep -v docker | sudo tee $SERVERNAME/etc/apt/sources.list >/dev/null
if [ "$CHROOTDEBVERSION" = "buster" ]; then
	sudo sed -e 's/stretch/buster/g' -i $SERVERNAME/etc/apt/sources.list
fi
sudo chroot $SERVERNAME apt update
echo 'keyboard-configuration  keyboard-configuration/model    select  Generic 105-key (Intl) PC' | sudo chroot $SERVERNAME debconf-set-selections
echo 'keyboard-configuration  keyboard-configuration/modelcode        string  pc105' | sudo chroot $SERVERNAME debconf-set-selections
echo 'keyboard-configuration  keyboard-configuration/xkb-keymap       select  de' | sudo chroot $SERVERNAME debconf-set-selections
echo 'keyboard-configuration  keyboard-configuration/variant  select  German' | sudo chroot $SERVERNAME debconf-set-selections
echo 'keyboard-configuration  keyboard-configuration/layout   select  German' | sudo chroot $SERVERNAME debconf-set-selections
echo 'locales locales/default_environment_locale      select  C.UTF-8' | sudo chroot $SERVERNAME debconf-set-selections
echo 'locales locales/locales_to_be_generated multiselect     de_DE.UTF-8 UTF-8, en_US.UTF-8 UTF-8' | sudo chroot $SERVERNAME debconf-set-selections
sudo chroot $SERVERNAME apt install locales -d -y
sudo chroot $SERVERNAME apt install locales -y
sudo chroot $SERVERNAME apt clean
sudo chroot $SERVERNAME apt dist-upgrade -d -y
sudo chroot $SERVERNAME apt upgrade -y
sudo chroot $SERVERNAME apt dist-upgrade -y
sudo chroot $SERVERNAME apt clean
sudo chroot $SERVERNAME apt install xfce4 xfce4-terminal thunderbird firefox-esr libreoffice evince rsync vim less screen openssh-server net-tools dirmngr mc x2goclient -y
sudo chroot $SERVERNAME apt clean
if [ "$CHROOTDEBVERSION" = "buster" ]; then
	sudo chroot $SERVERNAME apt install x2goserver x2goserver-xsession -d -y
	sudo chroot $SERVERNAME apt install x2goserver x2goserver-xsession -y
else
	sudo chroot $SERVERNAME apt install -t stretch-backports x2goserver x2goserver-xsession -d -y
	sudo chroot $SERVERNAME apt install -t stretch-backports x2goserver x2goserver-xsession -y
fi
sudo chroot $SERVERNAME apt clean
if [ "$CHROOTDEBVERSION" = "buster" ]; then
	wget -qnv https://download.opensuse.org/repositories/home:stevenpusser/Debian_Testing/Release.key -O - | sudo chroot $SERVERNAME apt-key add -
	echo 'deb http://download.opensuse.org/repositories/home:/stevenpusser/Debian_Testing/ /' | sudo tee $SERVERNAME/etc/apt/sources.list.d/home:stevenpusser.list
else
	wget -qnv https://download.opensuse.org/repositories/home:stevenpusser/Debian_9.0/Release.key -O - | sudo chroot $SERVERNAME apt-key add -
	echo 'deb http://download.opensuse.org/repositories/home:/stevenpusser/Debian_9.0/ /' | sudo tee $SERVERNAME/etc/apt/sources.list.d/home:stevenpusser.list
fi
sudo chroot $SERVERNAME apt update
sudo chroot $SERVERNAME apt install palemoon -y
sudo chroot $SERVERNAME apt clean
sudo chroot $SERVERNAME useradd -m $USERNAME -s /bin/bash
if [ -d $HOMEDIR_ROOT/etc/ssh/ ] ; then
	sudo cp -a $HOMEDIR_ROOT/etc/ssh/*_key* $SERVERNAME/etc/ssh/
else
	sudo mkdir -p $HOMEDIR_ROOT/etc/ssh
fi
if [ -d $HOMEDIR_ROOT/root/.ssh/ ] ; then
	sudo cp -a $HOMEDIR_ROOT/root/.ssh $SERVERNAME/root
else
	sudo mkdir -p $HOMEDIR_ROOT/root/.ssh
	sudo chmod 700 $HOMEDIR_ROOT/root/.ssh
fi
if [ -f $HOMEDIR_ROOT/etc/shadow ] ; then
	sudo sed -e '/^root:/d' -i $SERVERNAME/etc/shadow
	sudo grep '^root:' $HOMEDIR_ROOT/etc/shadow | sudo tee -a $SERVERNAME/etc/shadow >/dev/null
else
	echo "Set password for root account:"
	while ! sudo chroot $SERVERNAME passwd ; do sleep 1; done
fi
if [ -f $HOMEDIR_ROOT/etc/shadow ] && sudo grep -q "^$USERNAME:" $HOMEDIR_ROOT/etc/shadow ; then
	sudo sed -e "/^$USERNAME:/d" -i $SERVERNAME/etc/shadow
	sudo grep "^$USERNAME:" $HOMEDIR_ROOT/etc/shadow | sudo tee -a $SERVERNAME/etc/shadow >/dev/null
else
	echo "Set password for account '$USERNAME':"
	while ! sudo chroot $SERVERNAME passwd $USERNAME; do sleep 1; done
	sudo chroot $SERVERNAME usermod -c "$USERREALNAME,,," $USERNAME
fi
sudo cp -a $SERVERNAME/etc/ssh/*_key* $HOMEDIR_ROOT/etc/ssh/
sudo cp -a $SERVERNAME/etc/shadow $HOMEDIR_ROOT/etc/
sudo sed -i -e 's/^#Port.*$/Port 222/g' -e 's/^#ListenAddress.*$/ListenAddress 127.0.0.1/' $SERVERNAME/etc/ssh/sshd_config
sudo umount $SERVERNAME/dev/pts $SERVERNAME/dev/shm $SERVERNAME/proc $SERVERNAME/sys $SERVERNAME/home
echo "Installation complete."
